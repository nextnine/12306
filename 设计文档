# 高并发火车票购票系统成熟度设计文档

## 0. 摘要
- 面向全国范围的火车票在线售票，支持 PC / APP / 小程序等多端接入。
- 核心目标：春运等峰值场景下仍保持高可用、高性能与公平购票体验，兼顾安全、合规与运维可观测性。
- 架构原则：服务解耦、读写分离、异步化削峰、热点分片、幂等补偿、多活容灾。

## 1. 范围与约束
- 范围：余票查询、下单/排队、支付、候补、退改签、通知、运营管理。
- 约束：实名购票法规、支付牌照/清结算合规、跨境/跨省数据合规；对外 SLA 需在多活部署下满足。
- 假设：铁路基础数据（时刻表/票价/车厢结构）由权威源同步，支付渠道具备高可用 SLA。

## 2. 角色与用户场景
- 乘客：查询余票、购票、候补、退改签、行程提醒、发票。
- 管理员/运营：放票策略、票价策略、黑白名单、风控策略、监控告警、运营报表。
- 风控/客服：风控策略配置、人工介入处理、申诉与异常工单。

## 3. 功能性需求
### 3.1 账户与身份
- 注册登录、实名验证、设备绑定，多因子认证（高风险场景可选）。
- 乘车人管理、常用联系人与出行偏好。

### 3.2 车次与余票查询
- 站到站/车次号查询、时间/车型/座席过滤，支持联程/跨站组合。
- 余票实时/准实时展示，支持价格、时长、经停、联程组合等排序。

### 3.3 购票与排队
- 车次锁定、车厢/座位偏好、连座/分散座选择。
- 高峰排队/候补机制，展示排队进度与预估成功率。
- 防黄牛：设备指纹、行为模型、限流/验证码、滑块/活体校验（按策略触发）。

### 3.4 支付与结算
- 多渠道支付（银行卡/钱包/三方支付），支持分账/担保。
- 订单超时未支付自动取消并回收余票。
- 支持发票申请、对账、退款闭环。

### 3.5 退票与改签
- 规则校验（开车前时间、阶梯费用、渠道限制、次数限制）。
- 改签库存锁定、差价补退、行程与座席变更通知。

### 3.6 候补与通知
- 候补排队、优先级策略、局部区间拼座自动匹配。
- 成功候补后自动扣款/确认，失败通知并可继续排队。
- 短信/Push/站内信/邮件全渠道通知。

### 3.7 管理与运营
- 车次配置、票价策略、放票策略、黑白名单与风控策略配置。
- 监控、运营看板、异常告警、日志审计、可视化报表。

## 4. 非功能性需求
- **容量目标**  
  - 峰值查询 QPS 500k，购票下单 QPS 30k，支付确认 QPS 10k。  
  - 单车次放票窗口并发 10k+ 请求，热点车次自动分片与排队。
- **可用性**  
  - 核心链路 99.99%，下单/支付/退改双活容灾，RPO≈0，RTO<5 分钟。
- **性能**  
  - 查询 P99 < 200ms，缓存命中 P99 < 50ms；下单 P99 < 800ms（含排队外延），支付确认 < 2s。
- **一致性**  
  - 库存扣减与订单状态最终一致，座位展示允许秒级延迟；规则与黑名单按版本发布、读写隔离。
- **安全与合规**  
  - 国密支持、敏感数据分级加密与脱敏，日志脱敏；实名购票合规审计。
- **可观测性**  
  - 指标/日志/链路三栈，按车次/线路维度切片；全链路压测与容量水位预警。

## 5. 体系结构设计
- **部署模型**：两地三中心双活，多 AZ 负载均衡，灰度/蓝绿发布。
- **网关层**：统一接入、鉴权、签名校验、限流、WAF、协议转换。
- **核心服务**  
  - 用户与实名、乘车人服务  
  - 行程/时刻表服务（只读 + 版本化缓存）  
  - 库存与座位服务（热点写，Redis + 持久化 DB）  
  - 下单/订单服务（事务编排、状态机）  
  - 支付服务（渠道接入、回调、分账、幂等）  
  - 候补/排队服务（异步队列、优先级调度）  
  - 退改签服务（规则校验、差额计算）  
  - 通知服务（短信/Push/站内信/邮件）  
  - 风控服务（行为评分、黑名单、频控、设备指纹）  
  - 配置与规则中心（灰度、版本控制）
- **基础设施**  
  - 多级缓存：本地缓存 + Redis Cluster + 只读副本 DB  
  - 消息队列：Kafka/RabbitMQ 削峰填谷、事件驱动  
  - 数据层：关系型 DB 分库分表（按车次/日期/线路分片），冷数据归档  
  - 分布式锁/协调：Redis RedLock / ZK / etcd  
  - 对象存储：票据、报表、日志归档  
  - 配置中心与服务注册：支持灰度、动态限流、动态规则

## 6. 数据模型与存储设计
- **关系型表域**：用户/实名/乘车人、订单、支付、退款、退改记录、发票、车次/时刻表、定价、车厢/座位结构、黑名单、配置版本、幂等表。
- **缓存键设计**  
  - 余票键：`stock:{date}:{train}:{segment}:{seatClass}`；热点分桶（车厢/区间分片），TTL + 版本号。  
  - 订单草稿/令牌键：`order:token:{uid}`，短 TTL 防重复提交。  
  - 排队/候补键：`queue:{train}:{date}:{seatClass}`，结合 MQ 与优先级。  
  - 幂等键：`pay:idemp:{payId}`、`callback:idemp:{channel}:{txId}`。
- **库存表示**  
  - 区间库存模型（区间树/位图），核心操作为区间扣减/合并；连座在车厢位图查找连续段。  
  - 热点车次使用分段原子扣减脚本（Lua/事务）并行处理，冷门车次可按座位粒度锁。
- **一致性与持久化**  
  - 库存写入 Redis（原子扣减）+ 异步落盘 MySQL（Binlog/CDC），故障回放补偿。  
  - 订单状态机事件驱动（Kafka），支付/退改使用事务消息或 Outbox 保证最终一致。  
  - 版本化配置/规则：写入主库，读取走只读库/缓存，推送变更事件。

## 7. 核心流程
### 7.1 余票查询
1. 网关鉴权、频控，必要时风控拦截。  
2. 查本地/Redis 缓存，未命中回源只读库，加载带版本号。  
3. 返回实时余票、候补可用性与排队/下单令牌种子。

### 7.2 下单（高峰排队）
1. 客户端携带令牌请求，网关限流 + 风控。  
2. 排队服务写入按车次/座席分片的队列，支持优先级。  
3. 库存服务消费队列，Lua/原子扣减库存并生成锁座记录。  
4. 订单服务创建订单草稿（待支付），返回支付态与超时时间。  
5. 超时未支付的锁座由定时任务/队列回收，库存回补。

### 7.3 支付与确认
1. 支付服务生成支付单并调起渠道；订单状态置为待支付。  
2. 渠道回调/异步通知经幂等表更新订单为已支付，生成取票码/二维码。  
3. 支付失败/超时则订单失败并回补库存。

### 7.4 候补流程
1. 提交候补需求并预授权/小额冻结。  
2. 候补服务监听退票/改签/释放座位事件，按优先级匹配区间/连座。  
3. 匹配成功自动扣减库存并完成支付确认；失败通知继续排队或结束。

### 7.5 退票与改签
1. 规则校验与费用计算。  
2. 退票：订单设为已退，异步回补库存与退款。  
3. 改签：先锁定新车次座位，再对原票退票，确保新旧票状态与库存一致。

## 8. 高并发与公平性策略
- 多级限流：网关限流（IP/设备/账号）、车次粒度令牌桶；热点车次动态阈值与降级。  
- 削峰填谷：下单/候补队列化处理，防瞬时写入雪崩。  
- 热点拆分：车厢/区间分片，独立锁与队列；缓存分片避免单点热点。  
- 幂等与去重：令牌防重、雪花 ID 全局订单号、支付回调幂等表。  
- 熔断与降级：查询只读降级、候补降级、非关键功能关闭；缓存失效保护（空值/兜底）。  
- 防黄牛：行为特征、设备指纹、黑名单、人机识别、动态验证码/滑块/活体。

## 9. 可用性与容灾
- 双活：跨机房数据多活复制（库存主写主-备强一致/半同步或单主写+多活读）。  
- MQ 多副本、持久化；缓存哨兵/自动故障切换。  
- 演练：单 AZ 故障、单集群故障、回放演练，验证 RTO/RPO。  
- 备份：库存/订单/支付定期快照 + Binlog 远程备份；脱敏数据用于回放/压测。

## 10. 安全与合规
- 全链路 HTTPS/国密，敏感字段分级加密与脱敏日志。  
- 权限模型：最小权限、分级审计，后台操作留痕。  
- 符合实名购票、隐私合规（告知/授权/可撤回），支付与清结算合规。

## 11. 运维与质量保障
- 可观测：APM + 指标 + 日志 + Tracing，全链路 ID 贯穿。  
- 自动化：CICD、灰度/金丝雀、自动回滚。  
- 压测与容量：定期全链路压测、容量评估与弹性扩缩；春运峰值专项压测。  
- 混沌工程：网络抖动、延迟、节点故障注入，验证容错。  
- 回退与补偿：订单/支付/库存补偿、对账，失败自动重试+人工预案。

## 12. 风险清单与缓解
- 热点车次排队过长：动态扩容、队列分片、临时限流与候补优先。  
- 缓存雪崩/穿透：多级缓存、热点预热、空值缓存、隔离降级。  
- 支付通道异常：渠道降级/切换、事务消息保障最终一致。  
- 黑客/黄牛攻击：频控、风控策略动态加严、验证码/活体、黑名单实时下发。  
- 跨机房网络抖动：就近路由、重试与幂等、读写隔离、降级策略。

## 13. 交付与里程碑（示例）
- M1：需求与风险评估，基线架构与数据模型评审，PoC 压测。  
- M2：核心链路（查询/下单/支付）完成，灰度发布与压测。  
- M3：候补、退改签、风控完善，多活切换与容灾演练。  
- M4：运营/监控看板上线，稳定性建设与持续优化。
