# 高并发火车票购票系统需求分析与系统设计

## 1. 背景与目标
- 面向全国范围的火车票在线售票，支持 PC、APP、小程序等多端接入。
- 核心目标：在春运等峰值场景下保持高可用和可扩展，保障购票体验的稳定与公平。

## 2. 用户场景
- 实时查询车次/余票，快速下单购票。
- 支持候补购票、排队购票、退票、改签、升舱/换座等操作。
- 支持多乘车人、多段行程、联程/跨站购票与支付。
- 提供订单查询、行程提醒、开票与报销凭证下载。

## 3. 功能性需求
### 3.1 账户与身份
- 注册登录、实名验证、设备绑定，多因子认证可选。
- 乘车人管理、常用联系人与出行偏好。

### 3.2 车次与余票查询
- 站到站/车次号查询、时间范围过滤、座席/车厢偏好筛选。
- 余票实时/准实时展示，支持价格、时长、经停、联程组合等排序。

### 3.3 购票与排队
- 车次锁定、座位偏好、车厢偏好、连座/分散座选择。
- 高峰期排队/候补机制，展示排队进度与预估结果。
- 下单防黄牛：设备指纹、行为模型、限流/验证码、滑块/活体校验（按风控策略触发）。

### 3.4 支付与结算
- 多支付渠道（银行卡、钱包、第三方支付），支持分账/担保交易。
- 订单超时未支付自动取消并回收余票。
- 支持发票申请、对账与退款闭环。

### 3.5 退票与改签
- 规则校验（开车前时间、票价阶梯费用、渠道限制）。
- 改签库存锁定、差价补退、行程与座席变更通知。

### 3.6 候补与通知
- 候补排队、优先级策略、局部区间拼座自动匹配。
- 成功候补后自动扣款/确认，失败则通知并可继续排队。
- 短信/Push/站内信/邮件通知行程、变更、验票码等。

### 3.7 管理与运营
- 车次配置、票价策略、放票策略、黑白名单与风控策略配置。
- 监控与运营看板、异常告警、日志审计。

## 4. 非功能性需求
- **容量目标**：
  - 峰值查询 QPS 500k，购票下单 QPS 30k，支付确认 QPS 10k。
  - 单车次放票窗口单点并发 10k+ 请求，热点车次自动分片与排队。
- **可用性**：核心链路 99.99%，关键接口（下单/支付/退改）双活容灾，RPO≈0，RTO<5 分钟。
- **性能**：
  - 查询接口 P99 < 200ms，库存命中缓存 P99 < 50ms。
  - 下单接口 P99 < 800ms（含排队外延），支付确认 < 2s。
- **一致性**：
  - 库存扣减与订单状态最终一致；对外座位展示允许短暂读写延迟（秒级）。
  - 票务规则、黑名单等配置按版本发布，读写隔离。
- **安全与合规**：
  - 支持国密算法、敏感数据加密存储与传输、日志脱敏。
  - 遵循实名购票法规，保留合规审计链路。
- **可观测性**：
  - 指标（QPS、错误率、延迟、队列积压）、日志、分布式追踪，支持按车次/线路维度切片。
  - 演练与压测：全链路压测与容量水位线预警。

## 5. 总体架构
- 多活部署（两地三中心），跨 AZ/机房流量就近接入，支持灰度与蓝绿发布。
- **网关层**：统一接入、协议转换、鉴权、签名校验、限流、WAF。
- **业务服务**（微服务/模块化）：
  - 用户与实名服务、乘车人服务。
  - 行程/车次/时刻表服务（只读，带版本化缓存）。
  - 库存与座位服务（核心热点，Redis + 持久化 DB）。
  - 下单/订单服务（事务编排，状态机）。
  - 支付服务（对接支付渠道、回调、分账）。
  - 候补/排队服务（异步队列、优先级调度）。
  - 退改签服务（规则校验、差额计算）。
  - 通知服务（短信/Push/站内信邮件统一通道）。
  - 风控服务（行为评分、黑名单、频控、设备指纹）。
  - 配置与规则中心（灰度/版本控制）。
- **基础设施**：
  - 多级缓存（本地缓存 + Redis Cluster + 只读副本 DB）。
  - 消息队列（Kafka/RabbitMQ）用于异步处理与削峰填谷。
  - 数据层：关系型数据库分库分表（按车次/日期/线路分片），冷数据归档。
  - 分布式锁/协调（基于 Redis RedLock / ZK / etcd）。
  - 对象存储用于票据、报表、日志归档。

## 6. 数据模型与存储设计
- **关系型**：用户、实名、乘车人、订单、支付、退款、退改记录、发票、车次/时刻表、定价、车厢/座位结构、黑名单、配置版本。
- **缓存键设计**：
  - 余票键：`stock:{date}:{train}:{segment}:{seatClass}`；热点分桶（车厢/区间分片），TTL 配合版本号。
  - 订单草稿/令牌键：`order:token:{uid}` 防重复提交，TTL 短时。
  - 排队/候补队列：`queue:{train}:{date}:{seatClass}`，结合消息队列。
- **库存表示**：
  - 以区间库存模型（区间树/位图），核心操作为区间扣减与合并，避免逐座位锁；连座需求在同车厢连续位图内寻找连续段。
  - 热点车次使用分段原子扣减脚本（Lua/事务）并行处理；冷门车次可按座位粒度锁。
- **一致性与持久化**：
  - 库存写入 Redis（原子扣减）+ 异步落盘 MySQL Binlog/CDC，故障回放补偿。
  - 订单状态机事件驱动（Kafka），支付/退改通过事务消息确保最终一致。

## 7. 核心流程
### 7.1 余票查询
1. 用户请求经网关鉴权与频控。
2. 查询缓存（Redis）；未命中回源只读库，加载到缓存并带版本号。
3. 返回实时余票与候补可用性；同时返回排队/下单令牌种子。

### 7.2 下单（高峰排队）
1. 客户端携带令牌发起下单，网关限流与风控校验。
2. 排队服务将请求写入消息队列/分布式队列，按车次/座席分片排队。
3. 库存服务消费队列，使用 Lua/原子指令扣减库存并生成锁座记录。
4. 订单服务创建订单草稿（待支付），返回支付态与超时时间。
5. 超时未支付的锁座由定时任务/队列回收并回补库存。

### 7.3 支付与确认
1. 支付服务生成支付单并调起渠道；订单服务记录状态为待支付。
2. 支付回调/异步通知通过幂等处理更新订单为已支付，生成取票码/二维码。
3. 若支付失败/超时，订单状态转失败并回补库存。

### 7.4 候补流程
1. 用户提交候补需求并锁定额度（预授权/小额冻结）。
2. 候补服务监听退票/改签/释放座位事件，基于优先级匹配区间/连座。
3. 匹配成功自动扣减库存并触发支付确认；失败通知用户继续排队或结束。

### 7.5 退票与改签
1. 校验规则与时间窗，计算手续费/差价。
2. 退票：订单状态更新为已退，异步回补库存与退款；
3. 改签：锁定新车次座位后原票退票，确保新旧票状态与库存的一致性。

## 8. 高并发与公平性策略
- **多级限流**：网关限流（IP/设备/账号），车次粒度令牌桶；热点车次动态提升阈值与降级策略。
- **削峰填谷**：下单/候补使用队列化处理，防止瞬时写入雪崩。
- **热点拆分**：热门车次按车厢/区间分片，独立锁与队列；热点数据分布式缓存分片热点键避免单分片压力。
- **幂等与去重**：令牌防重、订单号全局唯一（雪花 ID）、支付回调幂等表。
- **熔断与降级**：查询只读降级、候补降级、非关键功能关闭；缓存失效保护（空值/兜底数据）。
- **防黄牛**：行为特征建模、设备指纹、IP/账号黑名单、滑块/验证码动态触发、人机识别。

## 9. 可用性与容灾
- 跨机房双活，关键数据多活复制（库存以主写主-备强一致/半同步，或单主写+多活读）。
- MQ 多副本、持久化；缓存集群哨兵/自动故障切换。
- 灾备演练：定期演练单 AZ 故障、单集群故障、数据回放，确保 RTO/RPO 指标。
- 快照与备份：库存/订单/支付数据定期快照与 Binlog 远程备份；数据脱敏用于回放与压测。

## 10. 安全与合规
- 全链路 HTTPS/国密，敏感字段（证件号、手机号）分级加密与脱敏日志。
- 权限模型：最小权限、分级审计，后台操作留痕。
- 符合法规的实名购票、身份核验、隐私合规（告知/授权/可撤回）。

## 11. 运维与质量保障
- **可观测**：APM + 指标 + 日志 + Tracing，全链路 ID 贯穿。
- **自动化**：CICD，灰度/金丝雀发布，自动回滚。
- **压测与容量管理**：定期全链路压测、容量评估与弹性扩缩容；模拟春运流量场景。
- **混沌工程**：注入故障验证容错能力（网络抖动、延迟、节点故障）。
- **回退与补偿**：订单/支付/库存均有补偿与对账机制，失败自动重试与人工介入预案。

## 12. 交付与里程碑（示例）
- M1：需求与风险评估，基线架构与数据模型评审，PoC 压测。
- M2：核心链路（查询/下单/支付）开发完成，灰度发布与压测。
- M3：候补、退改签、风控完善，多活切换与容灾演练。
- M4：运营/监控看板上线，稳定性建设与持续优化。
