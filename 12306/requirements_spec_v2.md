# 高并发火车票购票系统——需求分析文档
> 版本：v2.0（2025-12-26）  
> 适用范围：互联网/移动售票场景，读峰值≥100 万 QPS、写峰值（出队后下单）≥20 万 TPS（排队削峰后）  
> 文档类型：需求规格（独立于概要设计）

---

## 目录
1. 引言  
2. 任务概述  
3. 数据描述  
4. 功能需求  
5. 性能需求  
6. 运行需求  
7. 其他需求  
8. 术语与缩写  
9. 用户需求定义  
10. 业务规则与约束  
11. 接口概览  
12. 验收标准与监控指标  
13. 附录  

---

## 一．引言
1. 编写目的：

   本需求说明书用于明确高并发售票系统的业务范围、功能需求与非功能性要求，面向产品、架构、研发、测试、运维及相关合作方统一需求理解与交付边界。本文档作为系统设计、开发实现、测试验收与上线运维的共同依据，支持需求到设计、测试用例与验收项的可追溯。文档同时给出关键接口与外部依赖（运行图、实名、支付、通知、风控等）的约束假设，作为联调与故障定位的参考。涉及数据安全与个人信息处理的要求，应遵循适用的国家/行业标准与组织安全规范（如个人信息保护相关标准等），并以可验证的指标、日志与审计证据作为验收依据。后续需求变更需通过评审流程更新版本并保留变更记录，以避免实现与验收口径不一致。
2. 项目背景：

   春运及节假日期间，购票流量呈现短时极端峰值，对系统的并发承载、稳定性、库存一致性与支付链路可靠性提出更高要求。本项目由委托方、开发方与运维方协同建设，目标是在高峰场景下实现“可用、可扩、可观测、可恢复”的售票能力，并满足实名合规与安全风控要求。系统需对接铁路运行图/余票库存、实名核验、支付与退款、通知触达及风控反作弊等外部系统，形成端到端闭环；因此对接口稳定性、幂等、验签、安全与降级策略有明确要求。由于外部系统存在延迟、限流与不确定性，系统需具备限流/熔断/重试/补偿与最终一致的容错机制，并确保关键业务链路可追踪、可审计。项目建设需兼顾平峰成本与峰值弹性，确保在极端流量下仍能维持核心功能可用并保证用户体验。
3. 定义：
- 区间段（Segment）：相邻站点的最小扣减单元。
- 区间票：跨多个区间段的票，扣减需全成全败。
- 预扣库存：在缓存/分布式存储中的原子扣减，待支付后落库确认。
- 锁座：占用具体席位，支付超时自动释放。
- 幂等键（Idempotent Key）：请求唯一指纹，防重复执行。
- 排队 Token：进入削峰排队后的查询凭据。
- 订单状态机：订单/支付/出票状态的有限状态流转。
- 缩写：QPS/TPS（每秒查询/事务数）、TTL（生存时间）、AZ（可用区）、DLQ（死信队列）、SLO/SLA（服务水平目标/协议）。  
4. 参考资料：项目任务书/合同（如有）；国家/行业规范（实名、安全、隐私相关）；支付/实名/短信等外部接口协议与验签规范；内部安全/加密/日志审计规范；性能与容量基线（历史压测/运营数据）。  

## 二．任务概述
1. 目标：  
   - 查询：P95 < 120ms，命中率≥95%，可用性 99.99%。缓存命中率长期保持在 95% 以上，未命中回源时配合熔断或降级兜底，避免瞬时雪崩。[^sre]   
   - 写峰值/出队后下单：P95 < 3s，峰值 ≥20 万 TPS，可用性 99.95%。写链路拆分排队、预扣、锁座、落账各阶段并单独监控，超阈值自动限速或转候补。[^sre]   
   - 一致性：库存 0 超卖，订单/支付/出票最终一致（分钟级对账纠偏）。对账覆盖订单↔支付↔票号↔库存账本，差异进入补偿流程并允许人工介入。[^ddia]   
2. 运行环境：云/数据中心，K8s 部署，同城多 AZ；依赖 Redis/Kafka/MySQL/ES/对象存储等。各组件配置自动扩缩容、健康检查与故障转移，跨 AZ 部署并定期演练切换。  
3. 条件与限制：实名与隐私合规；外部依赖 SLA/超时限制；上线配合开售节奏；容量/资源约束；发布采用灰度与回滚预案。开售前必须完成压测与频控/排队参数校准，并与支付/实名等外部 SLA 对齐。  

## 三．数据描述
1. 静态数据：站点/车次基础、席别/座席布局、价格和退改费率、黑白名单、风控/灰度策略。静态数据包含版本号与签名校验，支持全量与增量同步，并在缓存和只读库中保留回滚版本以便快速恢复。  
2. 动态数据：余票/库存、订单/明细、支付单、票号、候补请求、通知记录、日志/审计事件。动态数据携带时间戳与来源标识，关键链路写入账本并支持补偿回放，满足审计留痕与可追溯性。  
3. 数据库描述：OLTP 分库分表 MySQL；搜索/索引用 ES；缓存用 Redis；文件/报表用对象存储；事件用 Kafka/RabbitMQ。各存储定义容量与分片策略，具备高可用与故障切换，并落地冷热分层与备份恢复流程。[^dbmq]   
4. 数据词典：关键实体字段见本节与接口字段约定，完整字段/约束在数据字典（另行维护）。数据字典标注字段含义、类型、单位、是否加密/脱敏及索引/约束，并与接口契约双向校验。  
5. 数据采集：运行图/座席同步、实名结果、支付回调、客户端埋点（脱敏）、监控/日志采集用于运维与分析。采集链路定义频率、超时与重试策略，保证埋点不影响主链路性能，数据入湖前完成清洗脱敏。  

## 四．功能需求
1. 功能划分：查询、下单、支付与出票、退改候补、运营/风控、通知/客服、可观测。  
2. 功能描述：见下方功能/用例要点与规则。  

## 五．性能需求
1. 数据精确度：金额以分为单位[^currency]；库存/票数强一致；时间使用 ISO8601（含时区）。[^iso] 金额统一使用 int64 存分并校验币种，时间字段记录时区偏移并依赖 NTP/Chrony 校时，库存读写附带版本号以防脏写与超卖。  
2. 时间特性：查询 P95<120ms；下单出队后 P95<3s；排队等待 P95<60s。监控面板分层展示 P95/P99 与错误率，超过阈值时自动启用限流、降级或扩容，错误预算耗尽触发发布冻结。[^sre]   
3. 适应性：支持多终端，多 AZ 部署与弹性扩容；兼容外部接口版本演进。多终端统一鉴权/风控策略并兼容弱网，跨 AZ 配置数据与状态解耦，外部接口提供版本灰度与回滚能力。  

## 六．运行需求
1. 用户界面：覆盖 Web/APP/小程序，支持排队状态、支付跳转、订单与候补查询；界面细节在 UI 规范中定义。界面展示预计等待时间与进度条，错误提示包含可操作建议（重试/转候补/联系客服），并预留无障碍与多语言扩展。  
2. 硬件接口：依赖网络、负载均衡、K8s 节点与中间件集群；具体规格在部署文档中。开售期间提前扩容 LB/节点与中间件容量上限，并启用健康检查与自动摘除故障节点。  
3. 软件接口：对接运行图/实名/支付/通知/风控等外部接口；内部接口见接口约束与示例。外部接口明确 SLA、超时、签名/验签与幂等策略，内部接口统一鉴权、限流、幂等键透传与分区键规则。  
4. 故障处理：外部依赖超时/失败返回可诊断错误码，触发重试/降级；下单幂等返回已有结果；排队超限返回 423 并引导候补；核心异常按告警规则上报。故障时提供备用通道切换、熔断后快速恢复验证，以及可复用的演练脚本。[^fault]   

## 七．其他需求
- 可用性：查询 ≥99.99%，下单 ≥99.95%；核心接口错误率 <0.1%。明确可用性口径（是否计入外部依赖），在开售窗口设立变更冻结与容量保护，并配合自动化回滚与演练。  
- 安全与合规：实名、加密/脱敏、访问审计、风控联动。安全范围覆盖数据全生命周期（采集/传输/存储/访问/删除），运营与客服操作采用最小权限与双人审批，日志审计保持可追溯。  
- 可维护性/可移植性：服务无状态，支持滚动升级与多 AZ 部署；配置与代码分离。结合配置中心、特性开关与灰度/蓝绿发布能力，支撑跨 AZ/Region 的灾备切换与演练。  
- 可使用性：排队进度可视化、错误提示友好；多语言/无障碍可选（作为可配置项）。提供等待时间预估、候补成功率提示与客服/帮助入口，减少用户反复刷新与误操作。  

---

## 术语与缩写


---

## 用户需求定义

### 用户画像与场景
- 乘客端：高频通勤、节假日抢票、多乘客代购。关注极速查询、限购/冲突提示、排队透明、改签/退票便捷。
- 运营/客服：批量通知、异常单处理、候补人工介入、风控申诉。关注可视化监控、可追溯日志、手工补单/补偿。
- 外部合作方：支付、实名、运行图/座席、短信/邮件渠道。关注清晰 SLA、超时/重试/降级协议。

### 用例概览（用例图）
```mermaid
flowchart LR
  Passenger((乘客)) --> UC_Query[查询车次/余票]
  Passenger --> UC_Order[下单/排队/支付]
  Passenger --> UC_After[退票/改签/候补]
  Passenger --> UC_Notify[通知查看]
  Passenger --> UC_Profile[实名/乘客管理]
  Ops((运营/客服)) --> UC_After
  Ops --> UC_Notify
  Ops --> UC_Risk[风控/限流配置]
```

### 用例规约要点
- 查询：前置实名，命中缓存返回；未命中读只读库/ES；运行图失败降级提示。记录查询来源/渠道并限制频率，提供模糊与精确查询切换，降级时提示数据时效。  
- 下单：前置登录+实名+频控；主成功“排队→预扣+锁座→创建订单→返回支付”；扩展“库存不足→候补”“幂等重放返回已有结果”“风控→验证码/拒绝”。下单流程返回 queue_token、预计等待时间与支付有效期，失败分支提供重试或候补路径。  
- 退改/候补：前置“订单可退/可改/可候补”；主成功“校验规则→回补/重扣→退款/支付→状态前进”；扩展“改签失败保留旧票”“候补失败继续排队或结束”。明确费用与时间限制，标注退款路径与到账时间，候补失败时可重新排队或终止。  

### 功能需求
- 查询：站点/车次/余票/票价，退改/候补规则，行程/订单查询，缓存降级。支持按车次/日期/席别筛选与排序，提供缓存命中率与数据版本提示，未命中时限制回源并展示友好降级信息。  
- 下单：实名乘客选择、限购/冲突校验、排队 token、幂等下单、区间预扣与锁座、支付链接生成。接口返回 queue_token、幂等键校验结果与支付有效期，冲突时给出具体规则提示与可操作建议。  
- 支付与出票：支付单、回调幂等/验签、防重放；出票重试/失败退款、票号生成。支付覆盖多渠道并校验金额/币种一致性，出票失败进入补偿流程并通知用户。  
- 退改候补：费用/时间规则、改签双阶段（新票成功后作废旧票）、候补登记/抢票、退款跟踪。展示费用明细与预计到账时间，候补匹配成功后锁票并引导支付，失败时重试或自动转其它偏好。  
- 运营/风控：黑白名单、设备指纹（可选）、验证码/频控、灰度与配置开关。策略支持分区域/分渠道/分用户发布与审计。  
- 通知/客服：统一模板、失败重试、渠道熔断，异常单人工介入。跟踪送达率与延迟，客服可人工补发并切换渠道。  
- 可观测：监控看板、日志审计、压测与演练开关。看板按域拆分指标，压测与演练与生产流量隔离并可快速关闭。  

### 非功能需求
- 可用性：查询 ≥99.99%，下单 ≥99.95%。定义可用性计算口径、错误预算与告警阈值，关键变更通过灰度与回滚演练落实。  
- 性能：查询 QPS 百万级；写峰值/出队后下单 ≥20 万 TPS，P95 <3s。性能目标按模块拆分并在监控中展示 P95/P99，热点场景提前预热缓存与扩容。  
- 一致性：库存 0 超卖，订单/支付/库存最终一致。一致性策略涵盖 Redis 预扣、账本回写与对账补偿，在跨分片/跨服务场景保持幂等与顺序。  
- 安全与合规：实名、脱敏与加密、访问审计、风控联动。数据全链路 TLS，敏感字段列级加密与脱敏展示，运营操作遵循最小权限并可审计。  
- 运维/扩展：分库分表，可水平扩展，弹性伸缩、灰度、演练。支持自动扩缩容、容量预测、再分片计划与压测隔离，发布过程可蓝绿/金丝雀并自动回滚。  
- 数据精确度：金额以分为单位；库存/票数强一致；时间使用 ISO8601（含时区）。
- 适应性：支持多终端，支持多 AZ 部署与弹性扩容；兼容外部接口版本演进。

---

## 业务规则与约束
- 改签与多票：改签遵循时间与车次限制（如开车前≥30 分钟），差额与手续费按规则计算；改签成功作废旧票并回补库存；同乘客同一时间窗（如 2 小时）限持一张有效票，冲突场景先退/改再购。
- 排队速率：`r = min(0.02 * remain, 2000)` 单/秒，随剩余票量动态调整并封顶；超长队列转候补。[^queue]
- 频控/灰度：默认阈值（账号 3 QPS、设备 3 QPS、IP 10 QPS、日购票 5 次/账号、同乘客同车次 30 分钟冷却），灰度按标签/地市 1%~20% 可调，支持回滚窗口。
- 外部依赖：实名、支付、短信等明确 SLA、超时、最大重试（如 3 次指数退避）、熔断与降级返回码；依赖字段、签名/验签算法契约化。

---

## 接口概览

### 接口约束
- 写接口携带 `idempotent_key`；签名/鉴权头（token）、渠道标识；幂等冲突返回 409，频控返回 429。
- 错误码示例：`400_PARAM_INVALID`、`401_UNAUTHORIZED`、`403_RISK_REJECT`、`409_DUPLICATE`、`423_QUEUE_LIMIT`、`504_UPSTREAM_TIMEOUT`。
- 字段约定：金额分（int），时间 ISO8601，布尔小写。
- 故障处理：外部依赖超时或失败返回可诊断错误码并触发重试或降级；下单幂等返回已有结果；排队超限返回 423 并引导候补。[^fault]

### 接口示例
- `POST /order/queue`
  - 请求
  ```json
  {
    "train_no": "G1234",
    "date": "2025-02-01",
    "segment": ["BJP", "SHH"],
    "seat_class": "2ND",
    "passengers": [{"id": "P1", "name": "Zhang San", "id_type": "ID", "id_no": "xxxx"}],
    "idempotent_key": "u123-20250201-G1234-2ND-abc",
    "channel": "app"
  }
  ```
  - 响应
  ```json
  {
    "queue_token": "qt-8f3d",
    "status": "IN_QUEUE",
    "estimate_sec": 60
  }
  ```
- `GET /order/queue/{token}`
  - 响应
  ```json
  {
    "status": "READY_TO_PAY",
    "order_token": "ord-123",
    "pay_url": "https://pay.example.com/xxx"
  }
  ```
- `POST /payment/callback`
  - 请求
  ```json
  {
    "payment_id": "pay-123",
    "order_id": "ord-123",
    "status": "SUCCESS",
    "amount": 56000,
    "notify_version": 3,
    "sign": "xxx"
  }
  ```
  - 响应
  ```json
  { "code": 0, "msg": "ok" }
  ```

---

## 验收标准与监控指标
- 功能：零超卖；订单状态单向流转；支付回调幂等；改签/退票/候补可回滚。
- 性能：查询 P95<120ms、下单出队后 P95<3s，峰值写 TPS≥20 万；排队等待 P95<60s。
- 可用性：查询 99.99%、下单 99.95%，核心接口错误率 <0.1%。
- 安全：实名通过率达标，异常登录/下单触发风控；日志脱敏与审计可追溯。
- 监控：队列长度/出队速率、库存预扣成功率、锁座成功率、支付回调重复率/延迟、对账差值、DLQ 长度、缓存命中率、Redis/DB/消息 P95、外部依赖超时/熔断次数。

---

## 附录
- 参考：本需求文档为概要设计的输入，详细设计、测试计划、部署/运维手册另行编制。

## 参考与注释
- [^sre] 《Site Reliability Engineering》，第 4 章“Service Level Objectives”以及《The Site Reliability Workbook》第 5 章“SLOs”——用于 SLO/错误预算与延迟目标设定。
- [^ddia] 《Designing Data-Intensive Applications》，第 5 章“Replication”、第 9 章“Consistency and Consensus”、第 11 章“Stream Processing”——用于一致性、账本化与流补偿设计。
- [^dbmq] MySQL 8.0 Reference Manual 第 18 章“Group Replication/Partitioning”；Elasticsearch “Elasticsearch: The Definitive Guide”/官方索引与扩展章节；Redis Cluster 规范与 EVAL/Lua 保证原子性章节；Kafka 文档“Design/Replication/Producer Idempotence/Exactly-Once Semantics”；RabbitMQ 官方文档“Dead Letter Exchanges/Quorum queues/Retry & DLQ”。
- [^currency] ISO 4217 货币编码与“最小货币子单位”定义；Stripe/PayPal/支付宝/微信支付 API 文档均以最小货币单位（分/cent）传金额。
- [^iso] ISO 8601:2019 日期与时间格式标准；RFC 3339 第 5.6 节互联网日期/时间戳格式。
- [^fault] 《Release It!》（2nd Edition）第 5 章“Stability Patterns”；Resilience4j/Hystrix 官方文档（CircuitBreaker/Retry/RateLimiter/Bulkhead）；IETF RFC 9110/7231 第 15 章 HTTP 状态码语义。
- [^queue] 《Site Reliability Engineering》容量与过载管理章节；《The Site Reliability Workbook》第 15 章“Handling Overload”；Nginx `limit_req`/Envoy Rate Limit 过滤器官方指南；令牌桶/漏桶算法经典描述。
